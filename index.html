<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trivia League</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-purple: #8B31C9;
            --primary-pink: #E91E8C;
            --primary-green: #00FF41;
            --dark-bg: #0A0A0F;
            --card-bg: #1A1A24;
            --accent-yellow: #FFD700;
            --text-light: #FFFFFF;
            --text-dim: #A0A0B0;
        }

        body {
            font-family: 'Barlow Condensed', sans-serif;
            background: linear-gradient(135deg, #0A0A0F 0%, #1A1A24 50%, #0A0A0F 100%);
            color: var(--text-light);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 15px 0;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Setup Screen */
        .setup-screen {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid var(--primary-purple);
        }

        .setup-screen h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--primary-green);
            text-align: center;
            letter-spacing: 2px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            background: var(--dark-bg);
            border: 2px solid var(--primary-purple);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            font-family: 'Barlow Condensed', sans-serif;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .role-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .role-btn {
            padding: 12px;
            background: var(--dark-bg);
            border: 2px solid var(--primary-purple);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }

        .role-btn.active {
            background: var(--primary-pink);
            border-color: var(--primary-pink);
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            border: none;
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 15px;
            font-family: 'Bebas Neue', sans-serif;
        }

        .waiting-msg {
            text-align: center;
            padding: 20px;
            color: var(--primary-green);
            font-size: 1.1rem;
        }

        /* Game Screen */
        .game-screen {
            display: none;
        }

        /* Mobile-First Layout */
        .game-layout {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: var(--card-bg);
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
        }

        .team-score {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .team-score.left {
            color: var(--primary-pink);
        }

        .team-score.right {
            color: var(--primary-green);
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .video-container {
            position: relative;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--primary-purple);
            aspect-ratio: 1;
        }

        .video-container.host {
            grid-column: 1 / -1;
            aspect-ratio: 16/9;
            border-color: var(--accent-yellow);
        }

        .video-container.team-left {
            border-color: var(--primary-pink);
        }

        .video-container.team-right {
            border-color: var(--primary-green);
        }

        .video-container.empty {
            background: repeating-linear-gradient(
                45deg,
                var(--card-bg),
                var(--card-bg) 10px,
                var(--dark-bg) 10px,
                var(--dark-bg) 20px
            );
            opacity: 0.4;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-name {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.8);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .empty-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: center;
            padding: 5px;
        }

        .question-board {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 3px solid var(--primary-green);
            margin: 10px 0;
        }

        .category-banner {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 2px;
            text-align: center;
            text-transform: uppercase;
        }

        .question-text {
            font-size: 1.2rem;
            text-align: center;
            line-height: 1.3;
            margin-bottom: 15px;
            font-weight: 600;
            min-height: 60px;
        }

        .timer {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--accent-yellow);
            text-align: center;
        }

        /* Host Controls */
        .host-controls {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid var(--accent-yellow);
            margin-top: 10px;
        }

        .host-controls h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--accent-yellow);
        }

        .qr-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .qr-section canvas {
            max-width: 200px;
            height: auto;
        }

        .qr-hint {
            color: var(--dark-bg);
            font-weight: 600;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .player-assignment {
            background: var(--dark-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .player-assignment h4 {
            color: var(--primary-green);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .unassigned-player {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--text-dim);
        }

        .player-assignment-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .assign-btns {
            display: flex;
            gap: 5px;
        }

        .btn-assign {
            padding: 6px 12px;
            background: var(--primary-purple);
            border: none;
            border-radius: 5px;
            color: var(--text-light);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-assign:active {
            transform: scale(0.95);
        }

        .question-queue {
            margin-bottom: 15px;
        }

        .question-queue h4 {
            color: var(--primary-pink);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .queued-question {
            background: var(--dark-bg);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary-green);
        }

        .queued-category {
            font-weight: 700;
            color: var(--primary-green);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .queued-text {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        textarea {
            width: 100%;
            padding: 10px;
            background: var(--dark-bg);
            border: 2px solid var(--primary-purple);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.95rem;
            font-family: 'Barlow Condensed', sans-serif;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .control-row.full {
            grid-template-columns: 1fr;
        }

        .btn-secondary {
            padding: 10px;
            background: var(--primary-purple);
            border: none;
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-success {
            background: var(--primary-green);
            color: var(--dark-bg);
        }

        /* Desktop Layout */
        @media (min-width: 768px) {
            .logo {
                font-size: 4rem;
            }

            .game-layout {
                display: grid;
                grid-template-columns: 1fr 2fr 1fr;
                gap: 15px;
            }

            .score-header {
                grid-column: 1 / -1;
                font-size: 2rem;
                padding: 15px 25px;
            }

            .video-grid.left,
            .video-grid.right {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .video-grid.center {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .video-container {
                aspect-ratio: 4/3;
            }

            .video-container.host {
                aspect-ratio: 16/9;
            }

            .player-name {
                font-size: 0.9rem;
                padding: 5px 10px;
            }

            .question-text {
                font-size: 1.8rem;
                min-height: auto;
            }

            .timer {
                font-size: 4rem;
            }

            .control-row {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="logo">TRIVIA LEAGUE</h1>
        </div>

        <!-- Setup Screen -->
        <div class="setup-screen" id="setupScreen">
            <h2 id="setupTitle">Join the Game</h2>
            
            <div id="roleSelection">
                <div class="input-group">
                    <label>Select Role</label>
                    <div class="role-select">
                        <button class="role-btn active" id="hostBtn">Host</button>
                        <button class="role-btn" id="playerBtn">Player</button>
                    </div>
                </div>
            </div>

            <!-- Host Setup -->
            <div id="hostSetup">
                <div class="input-group">
                    <label>Your Name</label>
                    <input type="text" id="hostName" placeholder="Enter your name">
                </div>

                <div class="input-group">
                    <label>Team 1 Name</label>
                    <input type="text" id="team1Name" placeholder="Team 1" value="Team 1">
                </div>

                <div class="input-group">
                    <label>Team 2 Name</label>
                    <input type="text" id="team2Name" placeholder="Team 2" value="Team 2">
                </div>

                <div class="input-group">
                    <label>Players Per Team</label>
                    <select id="playersPerTeam">
                        <option value="1">1 Player</option>
                        <option value="2">2 Players</option>
                        <option value="3" selected>3 Players</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Number of Questions</label>
                    <input type="number" id="numQuestions" min="5" max="50" value="12">
                </div>

                <button class="btn-primary" id="createGameBtn">Create Game</button>
            </div>

            <!-- Player Join -->
            <div id="playerJoin" style="display: none;">
                <div class="input-group">
                    <label>Your Name</label>
                    <input type="text" id="playerName" placeholder="Enter your name">
                </div>

                <button class="btn-primary" id="joinGameBtn">Join Game</button>

                <div class="waiting-msg" id="playerWaiting" style="display: none;">
                    Waiting for host to assign you to a team...
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="game-layout">
                <!-- Score Header -->
                <div class="score-header">
                    <div class="team-score left">
                        <span id="team1NameDisplay">TEAM 1</span>
                        <span id="team1ScoreDisplay">0</span>
                    </div>
                    <div class="team-score right">
                        <span id="team2ScoreDisplay">0</span>
                        <span id="team2NameDisplay">TEAM 2</span>
                    </div>
                </div>

                <!-- Team 1 Videos -->
                <div class="video-grid left" id="team1Videos">
                    <div class="video-container team-left empty">
                        <video id="video1" autoplay playsinline></video>
                        <div class="player-name" id="name1" style="display:none;"></div>
                        <div class="empty-label" id="empty1">WAITING</div>
                    </div>
                    <div class="video-container team-left empty">
                        <video id="video2" autoplay playsinline></video>
                        <div class="player-name" id="name2" style="display:none;"></div>
                        <div class="empty-label" id="empty2">WAITING</div>
                    </div>
                    <div class="video-container team-left empty">
                        <video id="video3" autoplay playsinline></video>
                        <div class="player-name" id="name3" style="display:none;"></div>
                        <div class="empty-label" id="empty3">WAITING</div>
                    </div>
                </div>

                <!-- Center: Host + Question Board -->
                <div class="video-grid center">
                    <div class="video-container host">
                        <video id="videoHost" autoplay playsinline muted></video>
                        <div class="player-name" id="nameHost">Host</div>
                    </div>

                    <div class="question-board">
                        <div class="category-banner" id="categoryDisplay">WAITING TO START</div>
                        <div class="question-text" id="questionDisplay">Ready for trivia?</div>
                        <div class="timer" id="timerDisplay"></div>
                    </div>
                </div>

                <!-- Team 2 Videos -->
                <div class="video-grid right" id="team2Videos">
                    <div class="video-container team-right empty">
                        <video id="video4" autoplay playsinline></video>
                        <div class="player-name" id="name4" style="display:none;"></div>
                        <div class="empty-label" id="empty4">WAITING</div>
                    </div>
                    <div class="video-container team-right empty">
                        <video id="video5" autoplay playsinline></video>
                        <div class="player-name" id="name5" style="display:none;"></div>
                        <div class="empty-label" id="empty5">WAITING</div>
                    </div>
                    <div class="video-container team-right empty">
                        <video id="video6" autoplay playsinline></video>
                        <div class="player-name" id="name6" style="display:none;"></div>
                        <div class="empty-label" id="empty6">WAITING</div>
                    </div>
                </div>
            </div>

            <!-- Host Controls -->
            <div class="host-controls" id="hostControls" style="display: none;">
                <h3>ðŸŽ® Host Controls</h3>

                <!-- QR Code -->
                <div class="qr-section" id="qrSection">
                    <canvas id="qrCanvas"></canvas>
                    <div class="qr-hint">Scan to join game</div>
                </div>

                <!-- Player Assignment -->
                <div class="player-assignment" id="playerAssignment">
                    <h4>Unassigned Players (<span id="unassignedCount">0</span>)</h4>
                    <div id="unassignedList"></div>
                </div>

                <!-- Question Queue -->
                <div class="question-queue">
                    <h4>Question Queue (<span id="queueCount">0</span>)</h4>
                    <div id="queuedQuestions"></div>
                </div>

                <!-- Add Question -->
                <div class="input-group">
                    <label>Category</label>
                    <input type="text" id="categoryInput" placeholder="e.g., NBA, Movies">
                </div>

                <div class="input-group">
                    <label>Question</label>
                    <textarea id="questionInput" placeholder="Enter trivia question..."></textarea>
                </div>

                <div class="control-row full">
                    <button class="btn-secondary btn-success" id="addToQueueBtn">Add to Queue</button>
                </div>

                <!-- Game Controls -->
                <div class="control-row">
                    <button class="btn-secondary btn-success" id="nextQuestionBtn">Next Question</button>
                    <button class="btn-secondary" id="startTimerBtn">Timer (30s)</button>
                    <button class="btn-secondary" id="clearQuestionBtn">Clear</button>
                    <button class="btn-secondary" id="revealAnswerBtn">Reveal</button>
                </div>

                <!-- Scoring -->
                <div class="control-row">
                    <button class="btn-secondary btn-success" id="team1PointBtn">Team 1 +1</button>
                    <button class="btn-secondary" id="team1MinusBtn">Team 1 -1</button>
                    <button class="btn-secondary btn-success" id="team2PointBtn">Team 2 +1</button>
                    <button class="btn-secondary" id="team2MinusBtn">Team 2 -1</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PeerJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        // Game State
        let peer;
        let myStream;
        let connections = [];
        let playerData = {}; // { peerId: { name, stream, conn, team, slot } }
        let isHost = false;
        let questionQueue = [];
        let currentQuestionIndex = -1;
        let gameConfig = {
            hostName: '',
            team1Name: 'Team 1',
            team2Name: 'Team 2',
            playersPerTeam: 3,
            numQuestions: 12
        };
        let gameState = {
            category: '',
            question: '',
            answer: '',
            team1Score: 0,
            team2Score: 0,
            timerActive: false,
            timerValue: 30,
            teamAssignments: {}
        };

        // Check URL for auto-join
        const urlParams = new URLSearchParams(window.location.search);
        const urlHostId = urlParams.get('h');

        if (urlHostId) {
            document.getElementById('playerBtn').click();
        }

        // Role Selection
        document.getElementById('hostBtn').addEventListener('click', () => {
            document.getElementById('hostBtn').classList.add('active');
            document.getElementById('playerBtn').classList.remove('active');
            document.getElementById('hostSetup').style.display = 'block';
            document.getElementById('playerJoin').style.display = 'none';
            isHost = true;
        });

        document.getElementById('playerBtn').addEventListener('click', () => {
            document.getElementById('playerBtn').classList.add('active');
            document.getElementById('hostBtn').classList.remove('active');
            document.getElementById('hostSetup').style.display = 'none';
            document.getElementById('playerJoin').style.display = 'block';
            isHost = false;
        });

        // Create Game
        document.getElementById('createGameBtn').addEventListener('click', async () => {
            const hostName = document.getElementById('hostName').value.trim();
            if (!hostName) {
                alert('Please enter your name!');
                return;
            }

            gameConfig.hostName = hostName;
            gameConfig.team1Name = document.getElementById('team1Name').value.trim() || 'Team 1';
            gameConfig.team2Name = document.getElementById('team2Name').value.trim() || 'Team 2';
            gameConfig.playersPerTeam = parseInt(document.getElementById('playersPerTeam').value);
            gameConfig.numQuestions = parseInt(document.getElementById('numQuestions').value) || 12;

            // Get media
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            } catch (err) {
                alert('Could not access camera/microphone.');
                return;
            }

            // Initialize peer
            peer = new Peer();

            peer.on('open', (id) => {
                setupHostGame(id);
            });

            peer.on('connection', handlePlayerConnection);
            peer.on('call', handleIncomingCall);
        });

        function setupHostGame(peerId) {
            // Generate QR code
            const joinUrl = `${window.location.origin}${window.location.pathname}?h=${peerId}`;
            QRCode.toCanvas(document.getElementById('qrCanvas'), joinUrl, { width: 200 });

            // Show game screen
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('hostControls').style.display = 'block';

            // Set host video and name
            document.getElementById('videoHost').srcObject = myStream;
            document.getElementById('nameHost').textContent = gameConfig.hostName;

            // Set team names
            document.getElementById('team1NameDisplay').textContent = gameConfig.team1Name.toUpperCase();
            document.getElementById('team2NameDisplay').textContent = gameConfig.team2Name.toUpperCase();

            // Hide extra slots based on playersPerTeam
            hideExtraSlots();

            setupHostControls();
        }

        function hideExtraSlots() {
            for (let i = gameConfig.playersPerTeam + 1; i <= 3; i++) {
                document.getElementById(`video${i}`).parentElement.style.display = 'none';
                document.getElementById(`video${i + 3}`).parentElement.style.display = 'none';
            }
        }

        function handlePlayerConnection(conn) {
            connections.push(conn);

            conn.on('open', () => {
                const metadata = conn.metadata;
                if (metadata) {
                    playerData[conn.peer] = {
                        name: metadata.playerName,
                        conn: conn,
                        team: null,
                        slot: null,
                        stream: null
                    };
                    updateUnassignedList();
                }
            });

            conn.on('data', (data) => handleMessage(data, conn.peer));
            conn.on('close', () => {
                delete playerData[conn.peer];
                updateUnassignedList();
            });
        }

        function handleIncomingCall(call) {
            call.answer(myStream);
            call.on('stream', (remoteStream) => {
                const peerId = call.metadata?.peerId;
                if (peerId && playerData[peerId]) {
                    playerData[peerId].stream = remoteStream;
                    if (playerData[peerId].slot) {
                        assignVideoStream(playerData[peerId].slot, remoteStream, playerData[peerId].name);
                    }
                }
            });
        }

        function updateUnassignedList() {
            const list = document.getElementById('unassignedList');
            list.innerHTML = '';
            let count = 0;

            Object.keys(playerData).forEach(peerId => {
                const player = playerData[peerId];
                if (!player.team) {
                    count++;
                    const div = document.createElement('div');
                    div.className = 'unassigned-player';
                    div.innerHTML = `
                        <span class="player-assignment-name">${player.name}</span>
                        <div class="assign-btns">
                            <button class="btn-assign" onclick="assignPlayer('${peerId}', 1)">T1</button>
                            <button class="btn-assign" onclick="assignPlayer('${peerId}', 2)">T2</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });

            document.getElementById('unassignedCount').textContent = count;
            if (count === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:10px;">All assigned!</div>';
            }
        }

        function assignPlayer(peerId, team) {
            const player = playerData[peerId];
            if (!player) return;

            // Find next available slot for team
            const startSlot = team === 1 ? 1 : 4;
            const endSlot = startSlot + gameConfig.playersPerTeam - 1;

            for (let i = startSlot; i <= endSlot; i++) {
                if (!Object.values(playerData).some(p => p.slot === i)) {
                    player.team = team;
                    player.slot = i;
                    gameState.teamAssignments[peerId] = i;

                    if (player.stream) {
                        assignVideoStream(i, player.stream, player.name);
                    }

                    updateUnassignedList();
                    broadcastMessage({ type: 'assigned', slot: i, team: team });
                    return;
                }
            }

            alert(`Team ${team} is full!`);
        }

        function assignVideoStream(slot, stream, name) {
            const video = document.getElementById(`video${slot}`);
            const nameLabel = document.getElementById(`name${slot}`);
            const emptyLabel = document.getElementById(`empty${slot}`);

            video.srcObject = stream;
            nameLabel.textContent = name;
            nameLabel.style.display = 'block';
            emptyLabel.style.display = 'none';
            video.parentElement.classList.remove('empty');
        }

        // Join Game (Player)
        document.getElementById('joinGameBtn').addEventListener('click', async () => {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName || !urlHostId) {
                alert('Please enter your name!');
                return;
            }

            document.getElementById('playerWaiting').style.display = 'block';

            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            } catch (err) {
                alert('Could not access camera/microphone.');
                return;
            }

            peer = new Peer();

            peer.on('open', (myId) => {
                const conn = peer.connect(urlHostId, {
                    metadata: { playerName: playerName, peerId: myId }
                });

                conn.on('open', () => {
                    connections.push(conn);

                    const call = peer.call(urlHostId, myStream, {
                        metadata: { playerName: playerName, peerId: myId }
                    });

                    call.on('stream', (hostStream) => {
                        document.getElementById('videoHost').srcObject = hostStream;
                    });

                    conn.on('data', (data) => handleMessage(data));
                });
            });

            peer.on('call', (call) => {
                call.answer(myStream);
                call.on('stream', (remoteStream) => {
                    // Could be host or another player
                });
            });
        });

        // Host Controls
        function setupHostControls() {
            document.getElementById('addToQueueBtn').addEventListener('click', () => {
                const category = document.getElementById('categoryInput').value.trim();
                const question = document.getElementById('questionInput').value.trim();

                if (category && question) {
                    questionQueue.push({ category, question });
                    updateQueueDisplay();
                    document.getElementById('categoryInput').value = '';
                    document.getElementById('questionInput').value = '';
                }
            });

            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                if (questionQueue.length > 0) {
                    currentQuestionIndex = (currentQuestionIndex + 1) % questionQueue.length;
                    const q = questionQueue[currentQuestionIndex];
                    gameState.category = q.category;
                    gameState.question = q.question;
                    updateLocalDisplay();
                    broadcastGameState();
                }
            });

            document.getElementById('clearQuestionBtn').addEventListener('click', () => {
                gameState.category = '';
                gameState.question = '';
                gameState.timerActive = false;
                updateLocalDisplay();
                broadcastGameState();
            });

            document.getElementById('startTimerBtn').addEventListener('click', startTimer);

            document.getElementById('team1PointBtn').addEventListener('click', () => {
                gameState.team1Score++;
                updateLocalDisplay();
                broadcastGameState();
            });

            document.getElementById('team1MinusBtn').addEventListener('click', () => {
                gameState.team1Score = Math.max(0, gameState.team1Score - 1);
                updateLocalDisplay();
                broadcastGameState();
            });

            document.getElementById('team2PointBtn').addEventListener('click', () => {
                gameState.team2Score++;
                updateLocalDisplay();
                broadcastGameState();
            });

            document.getElementById('team2MinusBtn').addEventListener('click', () => {
                gameState.team2Score = Math.max(0, gameState.team2Score - 1);
                updateLocalDisplay();
                broadcastGameState();
            });
        }

        function updateQueueDisplay() {
            const container = document.getElementById('queuedQuestions');
            container.innerHTML = '';
            questionQueue.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'queued-question';
                div.innerHTML = `
                    <div class="queued-category">${q.category}</div>
                    <div class="queued-text">${q.question}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById('queueCount').textContent = questionQueue.length;
        }

        function updateLocalDisplay() {
            document.getElementById('categoryDisplay').textContent = gameState.category || 'WAITING';
            document.getElementById('questionDisplay').textContent = gameState.question || 'Ready for trivia?';
            document.getElementById('team1ScoreDisplay').textContent = gameState.team1Score;
            document.getElementById('team2ScoreDisplay').textContent = gameState.team2Score;
            document.getElementById('timerDisplay').textContent = gameState.timerActive ? gameState.timerValue : '';
        }

        function startTimer() {
            gameState.timerValue = 30;
            gameState.timerActive = true;
            updateLocalDisplay();
            broadcastGameState();

            const interval = setInterval(() => {
                gameState.timerValue--;
                updateLocalDisplay();
                broadcastGameState();

                if (gameState.timerValue <= 0) {
                    clearInterval(interval);
                    gameState.timerActive = false;
                    updateLocalDisplay();
                    broadcastGameState();
                }
            }, 1000);
        }

        function handleMessage(data, fromPeerId) {
            if (data.type === 'gameState') {
                updateGameState(data.state);
            } else if (data.type === 'assigned') {
                // Player was assigned - transition to game
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';

                document.getElementById('team1NameDisplay').textContent = gameConfig.team1Name?.toUpperCase() || 'TEAM 1';
                document.getElementById('team2NameDisplay').textContent = gameConfig.team2Name?.toUpperCase() || 'TEAM 2';
            }
        }

        function updateGameState(state) {
            gameState = state;
            updateLocalDisplay();
        }

        function broadcastGameState() {
            broadcastMessage({ type: 'gameState', state: gameState });
        }

        function broadcastMessage(msg) {
            connections.forEach(conn => {
                if (conn.open) {
                    try {
                        conn.send(msg);
                    } catch (err) {
                        console.error('Send error:', err);
                    }
                }
            });
        }
    </script>
</body>
</html>
